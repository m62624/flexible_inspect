variables:
  # ставим глобальную переменную image
  IMAGE: registry.gitlab.com/yourbandy-group/backend/pystval:latest

# ступени работы
stages:
  - build
  - linter

# базовая сборка
Build `Image` (dependencies):
  stage: build
  image: docker:stable
  services:
    - docker:dind
  before_script:
    # вводим данные для входа аккаунта
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" "$CI_REGISTRY"
  script:
    # получаем образ, если он существует, либо собираем по новой
    - docker pull $IMAGE || true
    # если есть прошлый образ, используем кэш (самое главное для скорости)
    - docker build --cache-from $IMAGE --build-arg BUILDKIT_INLINE_CACHE=1 -t $IMAGE .
    # заливаем образ в `Gitlab Contrainer Registry` для повторного использования
    - docker push $IMAGE

# проверяем сематнику & правописание
Linter check (clippy):
  stage: linter
  image: docker:stable
  services:
    - docker:dind
  before_script:
    # вводим данные для входа аккаунта
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" "$CI_REGISTRY"
  script:
    # получаем образ, если он существует, либо собираем по новой
    - docker pull $IMAGE || true
    # запускаем контейнер с примонтированным разделом,
    # где находится исходный код
    - docker run -v $CI_PROJECT_DIR:/app $IMAGE cargo clippy -- -D warnings
#==========================================================================================
# build image:
#   stage: build
#   image: docker:stable
#   services:
#     - docker:dind
#   script:
#     - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" "$CI_REGISTRY"
#     - docker pull $IMAGE
#     - docker build --cache-from $IMAGE -t $IMAGE .
#     - docker push $IMAGE
#   cache:
#     key: cargo-dependencies
#     paths:
#       - $CACHE_PATH

# check:
#   stage: test
#   image: docker:stable
#   services:
#     - docker:dind
#   script:
#     - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" "$CI_REGISTRY"
#     - docker pull $IMAGE
#     - docker build --cache-from $IMAGE -t $IMAGE .
#     - docker run --security-opt seccomp=unconfined -v $CI_PROJECT_DIR:/app $IMAGE cargo tarpaulin --engine llvm --out xml --output-dir ./coverage/
